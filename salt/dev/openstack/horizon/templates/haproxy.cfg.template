global
    log 127.0.0.1 local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4096
    user        haproxy
    group       haproxy
    daemon
    stats socket /var/lib/haproxy/stats
    
defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    retries 3
    option redispatch
    maxconn 8000
    contimeout 5000
    clitimeout 50000
    srvtimeout 50000

listen galera-cluster
        bind {{ VIP_HOSTNAME }}:3306
        balance  source
        option tcpka
        server {{ NODE_1 }} {{ NODE_1 }}:3306 check port 4567 inter 2000 rise 2 fall 5
        server {{ NODE_2 }} {{ NODE_2 }}:3306 check port 4567 inter 2000 rise 2 fall 5 backup 

listen mongodb-cluster
        bind {{ VIP_HOSTNAME }}:27017
        balance  source
        option tcpka
        server {{ NODE_1 }} {{ NODE_1 }}:27017 check inter 2000 rise 2 fall 5
        server {{ NODE_2 }} {{ NODE_2 }}:27017 check inter 2000 rise 2 fall 5 backup

listen rabbitmq
	bind	{{ VIP_HOSTNAME }}:5673
	balance source
	mode 	tcp
    option tcpka
	server 	{{ NODE_1 }} {{ NODE_1 }}:5672 check inter 2000 rise 2 fall 3
	server 	{{ NODE_2 }} {{ NODE_2 }}:5672 check inter 2000 rise 2 fall 3

listen memcache
	bind	{{ VIP_HOSTNAME }}:11211
	balance source
	mode 	tcp
	server 	{{ NODE_1 }} {{ NODE_1 }}:11211 check inter 2000 rise 2 fall 3
	server 	{{ NODE_2 }} {{ NODE_2 }}:11211 check inter 2000 rise 2 fall 3 backup

listen keystone_admin_cluster
        bind {{ VIP_HOSTNAME }}:35357
        balance  source
        option  tcpka
        option  httpchk
        option  tcplog
        server {{ NODE_1 }} {{ NODE_1 }}:35357 check inter 2000 rise 2 fall 5
        server {{ NODE_2 }} {{ NODE_2 }}:35357 check inter 2000 rise 2 fall 5 

listen keystone_public_internal_cluster
        bind {{ VIP_HOSTNAME }}:5000
        balance  source
        option  tcpka
        option  httpchk
        option  tcplog
        server {{ NODE_1 }} {{ NODE_1 }}:5000 check inter 2000 rise 2 fall 5
        server {{ NODE_2 }} {{ NODE_2 }}:5000 check inter 2000 rise 2 fall 5 

listen glance_api_cluster
  	bind {{ VIP_HOSTNAME }}:9292
  	balance  source
  	option  tcpka
  	option  httpchk
  	option  tcplog
  	server {{ NODE_1 }} {{ NODE_1 }}:9292 check inter 2000 rise 2 fall 5
  	server {{ NODE_2 }} {{ NODE_2 }}:9292 check inter 2000 rise 2 fall 5

listen glance_registry_cluster
  	bind {{ VIP_HOSTNAME }}:9191
  	balance  source
  	option  tcpka
  	option  tcplog
  	server {{ NODE_1 }} {{ NODE_1 }}:9191 check inter 2000 rise 2 fall 5
  	server {{ NODE_2 }} {{ NODE_2 }}:9191 check inter 2000 rise 2 fall 5

listen nova_compute_api_cluster
	  bind {{ VIP_HOSTNAME }}:8774
	  balance  source
	  option  tcpka
	  option  httpchk
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:8774 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:8774 check inter 2000 rise 2 fall 5

listen nova_metadata_api_cluster
	  bind {{ VIP_HOSTNAME }}:8775
	  balance  source
	  option  tcpka
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:8775 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:8775 check inter 2000 rise 2 fall 5

listen cinder_api_cluster
	  bind {{ VIP_HOSTNAME }}:8776
	  balance  source
	  option  tcpka
	  option  httpchk
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:8776 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:8776 check inter 2000 rise 2 fall 5

listen ceilometer_api_cluster
	  bind {{ VIP_HOSTNAME }}:8777
	  balance  source
	  option  tcpka
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:8777 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:8777 check inter 2000 rise 2 fall 5

listen vnc_cluster
	  bind {{ VIP_HOSTNAME }}:6080
	  balance  source
	  option  tcpka
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:6080 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:6080 check inter 2000 rise 2 fall 5

listen neutron_api_cluster
	  bind {{ VIP_HOSTNAME }}:9696
	  balance  source
	  option  tcpka
	  option  httpchk
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:9696 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:9696 check inter 2000 rise 2 fall 5

listen dashboard_cluster
	  bind {{ VIP_HOSTNAME }}:80
	  balance  source
	  option  tcpka
	  option  httpchk
	  option  tcplog
	  server {{ NODE_1 }} {{ NODE_1 }}:80 check inter 2000 rise 2 fall 5
	  server {{ NODE_2 }} {{ NODE_2 }}:80 check inter 2000 rise 2 fall 5

listen stats
	mode 		http
	bind 		0.0.0.0:8080
	stats		enable	
	stats 		refresh 30
	stats 		hide-version
	stats 		uri 		/haproxy_stats
	stats 		realm 	   	Haproxy\ Status
	stats 		auth		admin:admin
	stats 		admin		if TRUE	
